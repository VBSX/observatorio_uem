{% extends 'layout.html' %}

{% block content %}
<div class="admin-container">
    <div class="admin-main-actions">
        <a href="{{ url_for('admin_lendas') }}" class="btn-admin-nav">Gerenciar Lendas</a>
    </div>
    <h1>Painel de Administração de Relatos</h1>
    <p>Aqui você pode ver todos os relatos, aprovar os que estão pendentes e excluir os indesejados.</p>

    {% if denuncias_count > 0 %}
    <div class="admin-notification warning">
        <p><strong>Atenção:</strong> Você tem <strong>{{ denuncias_count }} comentário(s) denunciado(s)</strong> aguardando moderação. Use o filtro "Denunciados" para encontrá-los.</p>
    </div>
    {% endif %}

    <div class="admin-filters">
        <a href="{{ url_for('admin_relatos', filtro='pendentes') }}" class="btn-filter {% if filtro_ativo == 'pendentes' %}active{% endif %}">
            Pendentes
        </a>
        <a href="{{ url_for('admin_relatos', filtro='aprovados') }}" class="btn-filter {% if filtro_ativo == 'aprovados' %}active{% endif %}">
            Aprovados
        </a>
        <a href="{{ url_for('admin_relatos', filtro='todos') }}" class="btn-filter {% if filtro_ativo == 'todos' %}active{% endif %}">
            Todos
        </a>
        {% if denuncias_count > 0 or filtro_ativo == 'denunciados' %}
        <a href="{{ url_for('admin_relatos', filtro='denunciados') }}" class="btn-filter btn-filter-denuncia {% if filtro_ativo == 'denunciados' %}active{% endif %}">
            Denunciados ({{ denuncias_count }})
        </a>
        {% endif %}
    </div>

    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Local</th>
                    <th>Imagem</th>
                    <th>Status</th>
                    <th style="width: 280px;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for relato in relatos %}
                <tr class="status-{{ 'aprovado' if relato.aprovado == 1 else 'pendente' }}">
                    <td>{{ relato.id }}</td>
                    <td>{{ relato.titulo }}</td>
                    <td>{{ relato.local }}</td>
                    <td>
                        {% if relato.imagem_url %}
                            <a href="{{ relato.imagem_url }}" target="_blank" title="Clique para ver a imagem completa">
                                <img src="{{ relato.imagem_url }}" class="admin-thumbnail" alt="Miniatura do relato">
                            </a>
                        {% else %}
                            <span class="no-image">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if relato.aprovado == 1 %}
                            <span class="status-badge status-aprovado">Aprovado</span>
                        {% else %}
                            <span class="status-badge status-pendente">Pendente</span>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <button class="btn-action btn-view" onclick="toggleDescription({{ relato.id }})">Ver Conteúdo</button>

                        {% if relato.aprovado == 0 %}
                        <form action="{{ url_for('approve_relato', relato_id=relato.id, filtro=filtro_ativo) }}" method="POST">
                            <button type="submit" class="btn-action btn-approve">Aprovar</button>
                        </form>
                        {% endif %}
                        <form action="{{ url_for('delete_relato', relato_id=relato.id, filtro=filtro_ativo) }}" method="POST">
                            <button type="submit" class="btn-action btn-delete" onclick="return confirm('Tem certeza que deseja excluir este relato? Esta ação não pode ser desfeita.');">Excluir</button>
                        </form>
                    </td>
                </tr>
                <tr class="relato-description-row" id="desc-{{ relato.id }}" style="display: none;">
                    <td colspan="6">
                        <div class="relato-description-content">
                            <strong>Descrição Completa:</strong>
                            <p>{{ relato.descricao }}</p>

                            <div class="admin-metadata-section">
                                <strong>Metadados do Envio do Relato:</strong>
                                <ul>
                                    <li><strong>IP:</strong> {{ relato.ip_address or 'N/A' }}</li>
                                    <li><strong>Cidade:</strong> {{ relato.city or 'N/A' }}</li>
                                    <li><strong>Dispositivo/Navegador:</strong> {{ relato.user_agent or 'N/A' }}</li>
                                </ul>
                            </div>

                            <div class="admin-comments-section">
                                <strong>Comentários ({{ comentarios[relato.id]|length }}):</strong>
                                {% if comentarios[relato.id] %}
                                    <ul class="admin-comments-list">
                                        {% for comentario in comentarios[relato.id] %}
                                        <li class="admin-comment-item {% if comentario.denunciado == 1 %}denunciado{% endif %}">
                                            <div class="admin-comment-meta">
                                                <strong title="IP: {{ comentario.ip_address or 'N/A' }} | Cidade: {{ comentario.city or 'N/A' }}">{{ comentario.autor }}:</strong>
                                                <span>{{ comentario.texto }}</span>
                                                {% if comentario.denunciado == 1 %}
                                                    <span class="denuncia-flag">(DENUNCIADO)</span>
                                                {% endif %}
                                            </div>
                                            <div class="admin-comment-actions">
                                                {% if comentario.denunciado == 1 %}
                                                <form action="{{ url_for('unreport_comment', comment_id=comentario.id, filtro=filtro_ativo) }}" method="POST">
                                                    <button type="submit" class="btn-action btn-unreport" title="Remover denúncia e manter o comentário">Ignorar Denúncia</button>
                                                </form>
                                                {% endif %}
                                                <form action="{{ url_for('delete_comment', comment_id=comentario.id, filtro=filtro_ativo) }}" method="POST">
                                                    <button type="submit" class="btn-action btn-delete-comment" onclick="return confirm('Tem certeza que deseja excluir este comentário?');">Excluir</button>
                                                </form>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p>Nenhum comentário para este relato.</p>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" style="text-align: center;">Nenhum relato encontrado para este filtro.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function toggleDescription(relatoId) {
        const descRow = document.getElementById('desc-' + relatoId);
        if (descRow) {
            descRow.style.display = descRow.style.display === 'none' ? 'table-row' : 'none';
        }
    }
</script>
{% endblock %}
