{% extends 'layout.html' %}

{% block head_scripts %}
    {% if show_captcha %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    {% endif %}
{% endblock %}

{% block content %}
<div class="relato-container">
    <a href="{{ url_for('index') }}">&larr; Voltar para o Mapa</a>
    <article class="relato-full">
        <header>
            <h1>{{ relato.titulo }}</h1>
            <p class="relato-meta">
                <strong>Enviado por:</strong>
                {% if relato.autor_relato %}
                    <a href="{{ url_for('profile', user_id=relato.autor_id) }}">{{ relato.autor_relato }}</a>
                {% else %}
                    An√¥nimo
                {% endif %}
                |
                <strong>Local:</strong> {{ relato.local }} |
                <strong>Categoria:</strong> {{ relato.categoria }} |
                <strong>Data:</strong> {{ relato.criado_em.strftime('%d/%m/%Y') }}
            </p>
        </header>
        <div class="relato-body">
            {% if relato.imagem_url %}
            <div class="relato-image-container">
                <a href="{{ relato.imagem_url }}" target="_blank" title="Clique para ampliar a imagem">
                    <img src="{{ relato.imagem_url }}" alt="Imagem do relato: {{ relato.titulo }}" class="relato-image">
                </a>
            </div>
            {% endif %}

            {% if relato.audio_url %}
            <div class="relato-audio-container" style="margin-top: 20px;">
                <p><strong>√Åudio do relato:</strong></p>
                <audio controls src="{{ relato.audio_url }}" style="width: 100%;">
                    Seu navegador n√£o suporta o elemento de √°udio.
                </audio>
            </div>
            {% endif %}

            <p style="margin-top: 20px;">{{ relato.descricao | nl2br }}</p>
        </div>
        <footer>
            <div class="vote-section" data-relato-id="{{ relato.id }}">
                <p>Este relato √© cr√≠vel?</p>
                <div class="vote-buttons">
                    <button class="btn-vote acredito" data-voto="acredito" {% if voto_usuario %}disabled{% endif %}>
                        üëª Eu Acredito (<span id="votos-acredito">{{ relato.votos_acredito }}</span>)
                    </button>
                    <button class="btn-vote cetico" data-voto="cetico" {% if voto_usuario %}disabled{% endif %}>
                        ü§î C√©tico (<span id="votos-cetico">{{ relato.votos_cetico }}</span>)
                    </button>
                </div>
                <p id="vote-message" class="vote-message"></p>
                <div class="witness-section">
                    <button class="btn-vote witness" data-voto="witness" {% if testemunha_usuario %}disabled{% endif %}>
                        üëÄ Eu tamb√©m vi! (<span id="votos-testemunha">{{ relato.votos_testemunha }}</span>)
                    </button>
                    <p id="witness-message" class="vote-message"></p>
                </div>
            </div>
        </footer>
    </article>

    <section class="comments-section">
        <h2>Coment√°rios ({{ comentarios|length }})</h2>
        <div class="comments-list">
            {% for comentario in comentarios %}
            <div class="comment" id="comment-{{ comentario.id }}">
                <div class="comment-header">
                    <p class="comment-author">
                        <a href="{{ url_for('profile', user_id=comentario.autor_id) }}">
                            <strong>{{ comentario.autor }}</strong>
                        </a> 
                        em {{ comentario.criado_em.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                    <form action="{{ url_for('report_comment', comment_id=comentario.id) }}" method="POST" class="report-form">
                        {{ report_form.csrf_token }}
                        <button type="submit" class="btn-report" title="Denunciar este coment√°rio">Denunciar</button>
                    </form>
                </div>
                <p>{{ comentario.texto }}</p>
            </div>
            {% else %}
            <p>Nenhum coment√°rio ainda. Seja o primeiro a comentar!</p>
            {% endfor %}
        </div>

        {% if g.user %}
            <form method="POST" action="{{ url_for('add_comment', relato_id=relato.id) }}" class="comment-form" novalidate>
                <h3>Deixe seu Coment√°rio</h3>
                {{ comment_form.csrf_token }}
                <div class="form-group">
                    <div class="form-label-group">
                        {{ comment_form.texto.label }}
                        <span id="texto-counter" class="char-counter">1000</span>
                    </div>
                    {{ comment_form.texto(rows="4", required=True, maxlength="1000", oninput="updateCounter('texto', 1000)") }}
                    {% for error in comment_form.texto.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>

                {% if show_captcha %}
                <div class="form-group">
                    <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
                </div>
                {% endif %}

                {{ comment_form.submit(class="btn-submit") }}
            </form>
        {% else %}
            <p class="login-prompt">
                <a href="{{ url_for('login') }}">Fa√ßa login</a> para deixar um coment√°rio.
            </p>
        {% endif %}
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const voteSection = document.querySelector('.vote-section');
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content'); // Pega o token do layout

        if (voteSection) {
            voteSection.addEventListener('click', async (e) => {
                const button = e.target.closest('.btn-vote');
                if (!button || button.disabled) return;

                const relatoId = voteSection.dataset.relatoId;
                const tipoVoto = button.dataset.voto;
                let endpoint = '';
                let messageElId = '';
                
                if (tipoVoto === 'acredito' || tipoVoto === 'cetico') {
                    endpoint = `/vote/${relatoId}/${tipoVoto}`;
                    messageElId = 'vote-message';
                } else if (tipoVoto === 'witness') {
                    endpoint = `/witness/${relatoId}`;
                    messageElId = 'witness-message';
                }

                try {
                    const response = await fetch(endpoint, { 
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken // <-- TOKEN ENVIADO NO CABE√áALHO
                        }
                    });
                    const data = await response.json();
                    
                    const messageEl = document.getElementById(messageElId);
                    messageEl.textContent = data.message;

                    if (response.ok && data.success) {
                        if (tipoVoto === 'acredito') {
                            document.getElementById('votos-acredito').textContent = data.votos_acredito;
                            document.querySelector('.btn-vote.cetico').disabled = true;
                        } else if (tipoVoto === 'cetico') {
                            document.getElementById('votos-cetico').textContent = data.votos_cetico;
                            document.querySelector('.btn-vote.acredito').disabled = true;
                        } else if (tipoVoto === 'witness') {
                            document.getElementById('votos-testemunha').textContent = data.votos_testemunha;
                        }
                        button.disabled = true;
                        messageEl.style.color = 'green';
                    } else {
                        messageEl.style.color = 'red';
                    }
                } catch (error) {
                    document.getElementById(messageElId).textContent = 'Ocorreu um erro de rede.';
                }
            });
        }
        
        updateCounter('texto', 1000);
    });

    function updateCounter(fieldId, maxLength) {
        const field = document.getElementById(fieldId);
        const counter = document.getElementById(fieldId + '-counter');
        if (field && counter) {
            const remaining = maxLength - field.value.length;
            counter.textContent = remaining;
            counter.style.color = remaining < 20 ? (remaining < 0 ? '#ff0000' : '#ffc107') : '#aaa';
        }
    }
</script>
{% endblock %}