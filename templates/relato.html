{% extends 'layout.html' %}

{% block head_scripts %}
    {% if show_captcha %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    {% endif %}

    <style>
        .btn-vote:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .vote-info-message {
            color: #aaa;
            font-style: italic;
            font-size: 0.9em;
        }
    </style>
{% endblock %}

{% block content %}
<div class="relato-container">
    <a href="{{ url_for('index') }}">&larr; Voltar para o Mapa</a>
    <article class="relato-full">
        <header>
            <h1>{{ relato.titulo }}</h1>
            <p class="relato-meta">
                <strong>Enviado por:</strong>
                {% if relato.autor_relato %}
                    <a href="{{ url_for('profile', user_id=relato.autor_id) }}" class="relato-name">{{ relato.autor_relato }}</a>
                {% else %}
                    An√¥nimo
                {% endif %}
                |
                <strong>Local:</strong> {{ relato.local }} |
                <strong>Categoria:</strong> {{ relato.categoria }} |
                <strong>Data:</strong> {{ relato.criado_em.strftime('%d/%m/%Y') }}
            </p>
        </header>
        <div class="relato-body">
            {% if relato.imagem_url %}
            <div class="relato-image-container">
                <a href="{{ relato.imagem_url }}" target="_blank" title="Clique para ampliar a imagem">
                    <img src="{{ relato.imagem_url }}" alt="Imagem do relato: {{ relato.titulo }}" class="relato-image">
                </a>
            </div>
            {% endif %}

            {% if relato.audio_url %}
            <div class="relato-audio-container" style="margin-top: 20px;">
                <p><strong>√Åudio do relato:</strong></p>
                <audio controls src="{{ relato.audio_url }}" style="width: 100%;">
                    Seu navegador n√£o suporta o elemento de √°udio.
                </audio>
            </div>
            {% endif %}

            <p style="margin-top: 20px;">{{ relato.descricao | nl2br }}</p>
        </div>
        <footer>
            <div class="vote-section" data-relato-id="{{ relato.id }}">
                <p>Este relato √© cr√≠vel?</p>
                <div class="vote-buttons">
                    <button class="btn-vote acredito" data-voto="acredito" {% if voto_usuario %}disabled{% endif %}>
                        <span class="btn-vote-text">üëª Eu Acredito</span> (<span id="votos-acredito">{{ relato.votos_acredito }}</span>)
                    </button>
                    <button class="btn-vote cetico" data-voto="cetico" {% if voto_usuario %}disabled{% endif %}>
                        <span class="btn-vote-text">ü§î C√©tico</span> (<span id="votos-cetico">{{ relato.votos_cetico }}</span>)
                    </button>
                </div>

                <p id="vote-message" class="vote-message">
                    {% if voto_usuario %}
                        <span class="vote-info-message">Voc√™ j√° votou neste relato.</span>
                    {% endif %}
                </p>

                <div class="witness-section">
                    <button class="btn-vote witness" data-voto="witness" {% if testemunha_usuario %}disabled{% endif %}>
                        <span class="btn-vote-text">üëÄ Eu tamb√©m vi!</span> (<span id="votos-testemunha">{{ relato.votos_testemunha }}</span>)
                    </button>
                    <p id="witness-message" class="vote-message">
                        {% if testemunha_usuario %}
                            <span class="vote-info-message">Voc√™ j√° marcou que tamb√©m testemunhou este evento.</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </footer>
    </article>

    <section class="comments-section">
        <h2>Coment√°rios ({{ comentarios|length }})</h2>
        <div class="comments-list">
            {% for comentario in comentarios %}
            <div class="comment" id="comment-{{ comentario.id }}">
                <div class="comment-header">
                    <p class="comment-author">
                        <img src="{{ comentario.profile_pic_url or url_for('static', filename='img/default_avatar.png') }}" alt="Foto de {{ comentario.autor }}" class="profile-avatar">
                        <a href="{{ url_for('profile', user_id=comentario.autor_id) }}" class="comment-author-name">
                            <strong>{{ comentario.autor }}</strong>
                        </a> 
                        em {{ comentario.criado_em.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                    <form action="{{ url_for('report_comment', comment_id=comentario.id) }}" method="POST" class="report-form">
                        {{ report_form.csrf_token }}
                        <button type="submit" class="btn-report" title="Denunciar este coment√°rio">Denunciar</button>
                    </form>
                    
                    <div class="like-container" data-comment-id="{{ comentario.id }}">
                        {% set is_liked = comentario.id in liked_comments %}
                        <img 
                            src="{{ url_for('static', filename='images/ghost.png' if is_liked else 'images/ghost_sem_like.png') }}" 
                            alt="Votar coment√°rio" 
                            class="like-icon {{ 'liked' if is_liked else 'not-liked' }}" 
                            title="Votar coment√°rio">
                        <span class="like-count">{{ comentario.like_count }}</span>
                    </div>
                </div>
                <p>{{ comentario.texto }}</p>
            </div>
            {% else %}
            <p>Nenhum coment√°rio ainda. Seja o primeiro a comentar!</p>
            {% endfor %}
        </div>

        {% if g.user %}
            <form method="POST" action="{{ url_for('add_comment', relato_id=relato.id) }}" class="comment-form" novalidate>
                <h3>Deixe seu Coment√°rio</h3>
                {{ comment_form.csrf_token }}
                <div class="form-group">
                    <div class="form-label-group">
                        {{ comment_form.texto.label }}
                        <span id="texto-counter" class="char-counter">1000</span>
                    </div>
                    {{ comment_form.texto(rows="4", required=True, maxlength="1000", oninput="updateCounter('texto', 1000)") }}
                    {% for error in comment_form.texto.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>

                {% if show_captcha %}
                <div class="form-group">
                    <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
                </div>
                {% endif %}

                {{ comment_form.submit(class="btn-submit") }}
            </form>
        {% else %}
            <p class="login-prompt">
                <a href="{{ url_for('login') }}">Fa√ßa login</a> para deixar um coment√°rio.
            </p>
        {% endif %}
    </section>
</div>

<script>
    function updateCounter(fieldId, maxLength) {
        const field = document.getElementById(fieldId);
        const counter = document.getElementById(fieldId + '-counter');
        if (field && counter) {
            const remaining = maxLength - field.value.length;
            counter.textContent = remaining;
            counter.style.color = remaining < 20 ? (remaining < 0 ? '#ff0000' : '#ffc107') : '#aaa';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('texto')) {
            updateCounter('texto', 1000);
        }

        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        if (!csrfToken) {
            console.error("ERRO CR√çTICO: Meta tag CSRF 'csrf-token' n√£o encontrada no <head>.");
        }

        const voteSection = document.querySelector('.vote-section');
        if (voteSection) {
            voteSection.addEventListener('click', async (e) => {
                const button = e.target.closest('.btn-vote');
                if (!button || button.disabled) return;

                const tipoVoto = button.dataset.voto;
                const messageEl = document.getElementById(tipoVoto === 'witness' ? 'witness-message' : 'vote-message');
                const relatoId = voteSection.dataset.relatoId;
                const endpoint = (tipoVoto === 'acredito' || tipoVoto === 'cetico') 
                                ? `/vote/${relatoId}/${tipoVoto}` 
                                : `/witness/${relatoId}`;

                const buttonsToDisable = [];
                if (tipoVoto === 'acredito' || tipoVoto === 'cetico') {
                    buttonsToDisable.push(voteSection.querySelector('.btn-vote.acredito'));
                    buttonsToDisable.push(voteSection.querySelector('.btn-vote.cetico'));
                } else if (tipoVoto === 'witness') {
                    buttonsToDisable.push(voteSection.querySelector('.btn-vote.witness'));
                }

                buttonsToDisable.forEach(btn => { if(btn) btn.disabled = true; });

                try {
                    const response = await fetch(endpoint, { 
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken }
                    });
                    const data = await response.json();

                    if (messageEl) {
                        messageEl.textContent = data.message;
                        messageEl.style.color = data.success ? 'green' : 'red';
                    }

                    if (data.success) {
                        if (data.votos_acredito !== undefined) document.getElementById('votos-acredito').textContent = data.votos_acredito;
                        if (data.votos_cetico !== undefined) document.getElementById('votos-cetico').textContent = data.votos_cetico;
                        if (data.votos_testemunha !== undefined) document.getElementById('votos-testemunha').textContent = data.votos_testemunha;
                    } else {
                        buttonsToDisable.forEach(btn => { if(btn) btn.disabled = false; });
                    }
                } catch (error) {
                    console.error("Erro na requisi√ß√£o de voto:", error);
                    if (messageEl) {
                        messageEl.textContent = 'Falha na comunica√ß√£o com o servidor.';
                        messageEl.style.color = 'red';
                    }
                    buttonsToDisable.forEach(btn => { if(btn) btn.disabled = false; });
                }
            });
        }
        
        // --- L√ìGICA DE LIKE/UNLIKE ATUALIZADA ---
        document.querySelectorAll('.like-icon').forEach(icon => {
            icon.addEventListener('click', async function likeToggleHandler(e) {
                const likeIcon = e.target;
                const commentContainer = likeIcon.closest('.like-container');
                const commentId = commentContainer.dataset.commentId;

                if (!commentId || !csrfToken) {
                    console.error("Faltando ID do coment√°rio ou token CSRF.");
                    return;
                }

                // Previne cliques m√∫ltiplos enquanto a requisi√ß√£o est√° em andamento
                if (likeIcon.classList.contains('processing')) return;
                likeIcon.classList.add('processing');

                try {
                    const response = await fetch(`/like_comment/${commentId}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken }
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        const likeCountSpan = commentContainer.querySelector('.like-count');
                        if (likeCountSpan) {
                            likeCountSpan.textContent = data.contagens;
                        }

                        // Alterna o estado do √≠cone com base na resposta do servidor
                        if (data.action === 'liked') {
                            likeIcon.src = likeIcon.src.replace('ghost_sem_like.png', 'ghost.png');
                            likeIcon.classList.remove('not-liked');
                            likeIcon.classList.add('liked');
                        } else if (data.action === 'unliked') {
                            likeIcon.src = likeIcon.src.replace('ghost.png', 'ghost_sem_like.png');
                            likeIcon.classList.remove('liked');
                            likeIcon.classList.add('not-liked');
                        }
                    } else {
                        alert(data.message || 'N√£o foi poss√≠vel registrar sua a√ß√£o.');
                    }
                } catch (error) {
                    console.error("Erro na requisi√ß√£o de like/unlike:", error);
                    alert('Falha na comunica√ß√£o ao tentar interagir com o coment√°rio.');
                } finally {
                    // Libera o √≠cone para o pr√≥ximo clique
                    likeIcon.classList.remove('processing');
                }
            });
        });
    });
</script>
{% endblock %}