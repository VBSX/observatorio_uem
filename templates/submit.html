{% extends 'layout.html' %}

{% block head_scripts %}
    {% if show_captcha %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    {% endif %}
{% endblock %}

{% block content %}
    <h2>Relate sua Experiência Sobrenatural</h2>
    
    {% if g.user %}
        <p class="form-notice">Você está logado como <strong>{{ g.user.nome }}</strong>. Seu relato será associado ao seu perfil.</p>
    {% else %}
        <p class="form-notice">Você não está logado. Seu relato será enviado anonimamente. <a href="{{ url_for('login') }}">Faça login</a> para que ele seja associado ao seu perfil.</p>
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate>
        <div class="form-group">
            <div class="form-label-group">
                <label for="titulo">Título do Relato</label>
                <span id="titulo-counter" class="char-counter">100</span>
            </div>
            <input type="text" name="titulo" placeholder="Ex: Vulto no corredor do Bloco C56" id="titulo" value="{{ form_data.titulo or '' }}" required maxlength="100" oninput="updateCounter('titulo', 100)">
        </div>
        
        <div class="form-group">
            <label for="local-select">Onde Aconteceu?</label>
            <select name="local" id="local-select" required>
                <option value="" disabled {% if not form_data.local %}selected{% endif %}>Selecione um local...</option>
                {% for local in locais %}
                    <option value="{{ local }}" {% if form_data.local == local %}selected{% endif %}>{{ local }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" id="outro-local-container" style="display: none;">
            <label for="outro-local-texto">Especifique o local:</label>
            <input type="text" name="outro_local_texto" id="outro-local-texto" placeholder="Ex: No banco debaixo da árvore em frente ao RU" value="{{ form_data.outro_local_texto or '' }}">
        </div>

        <div class="form-group">
            <label for="categoria">Qual o tipo de fenômeno?</label>
            <select name="categoria" id="categoria" required>
                <option value="" disabled {% if not form_data.categoria %}selected{% endif %}>Selecione uma categoria...</option>
                {% for cat in categorias %}
                <option value="{{ cat }}" {% if form_data.categoria == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <div class="form-label-group">
                <label for="descricao">Descreva o que aconteceu</label>
                <span id="descricao-counter" class="char-counter">2000</span>
            </div>
            <textarea name="descricao" placeholder="Conte os detalhes da sua experiência..." id="descricao" rows="8" required maxlength="2000" oninput="updateCounter('descricao', 2000)">{{ form_data.descricao or '' }}</textarea>
        </div>

        <div class="form-group">
            <label for="imagem">Enviar Imagem (Opcional)</label>
            <input type="file" name="imagem" id="imagem" accept="image/png, image/jpeg, image/gif">
        </div>
        
        <div class="form-group">
            <label for="audio">Áudio (opcional):</label>
            <input type="file" id="audio" name="audio" accept="audio/*">
        </div>

        {% if show_captcha %}
        <div class="form-group">
            <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
        </div>
        {% endif %}
        
        <div class="form-group">
            <button type="submit">Enviar para o Mapa</button>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const localSelect = document.getElementById('local-select');
            const outroLocalContainer = document.getElementById('outro-local-container');
            const outroLocalInput = document.getElementById('outro-local-texto');

            function toggleOutroLocal() {
                if (localSelect.value === 'Outro Local / Não Listado') {
                    outroLocalContainer.style.display = 'block';
                    outroLocalInput.required = true;
                } else {
                    outroLocalContainer.style.display = 'none';
                    outroLocalInput.required = false;
                }
            }

            localSelect.addEventListener('change', toggleOutroLocal);
            
            // Inicializa o estado do campo "Outro Local" e dos contadores
            toggleOutroLocal();
            updateCounter('titulo', 100);
            updateCounter('descricao', 2000);
        });

        function updateCounter(fieldId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(fieldId + '-counter');
            if (field && counter) {
                const remaining = maxLength - field.value.length;
                counter.textContent = remaining;
                counter.style.color = remaining < 20 ? (remaining < 0 ? '#ff0000' : '#ffc107') : '#aaa';
            }
        }
    </script>
{% endblock %}
