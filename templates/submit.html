{% extends 'layout.html' %}

{% block head_scripts %}
    {% if show_captcha %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    {% endif %}
{% endblock %}

{% block content %}
    <h2>Relate sua Experiência Sobrenatural</h2>
    
    {% if g.user %}
        <p class="form-notice">Você está logado como <strong>{{ g.user.nome }}</strong>. Seu relato será associado ao seu perfil.</p>
    {% else %}
        <p class="form-notice">Você não está logado. Seu relato será enviado anonimamente. <a href="{{ url_for('login') }}">Faça login</a> para que ele seja associado ao seu perfil.</p>
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate>
        {{ form.csrf_token }}

        <div class="form-group">
            <div class="form-label-group">
                {{ form.titulo.label }}
                <span id="titulo-counter" class="char-counter">100</span>
            </div>
            {{ form.titulo(class="form-control", placeholder="Ex: Vulto no corredor do Bloco C56", maxlength="100", oninput="updateCounter('titulo', 100)") }}
            {% for error in form.titulo.errors %}
                <span class="error-message">{{ error }}</span>
            {% endfor %}
        </div>
        
        <div class="form-group">
            {{ form.local.label(for=form.local.id) }}
            {{ form.local(class="form-control") }}
        </div>

        <div class="form-group" id="outro-local-container" style="display: none;">
            {{ form.outro_local_texto.label(for=form.outro_local_texto.id) }}
            {{ form.outro_local_texto(class="form-control", placeholder="Ex: No banco debaixo da árvore em frente ao RU") }}
        </div>

        <div class="form-group">
            {{ form.categoria.label }}
            {{ form.categoria(class="form-control") }}
        </div>

        <div class="form-group">
            <div class="form-label-group">
                {{ form.descricao.label }}
                <span id="descricao-counter" class="char-counter">2000</span>
            </div>
            {{ form.descricao(class="form-control", rows="8", placeholder="Conte os detalhes da sua experiência...", maxlength="2000", oninput="updateCounter('descricao', 2000)") }}
            {% for error in form.descricao.errors %}
                <span class="error-message">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.imagem.label }}
            {{ form.imagem(class="form-control-file", accept="image/png, image/jpeg, image/gif") }}
        </div>
        
        <div class="form-group">
            {{ form.audio.label }}
            {{ form.audio(class="form-control-file", accept="audio/*") }}
        </div>

        {% if show_captcha %}
        <div class="form-group">
            <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
        </div>
        {% endif %}
        
        <div class="form-group">
            {{ form.submit(class="btn-submit") }}
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Note que usamos '{{ form.local.id }}' para garantir que pegamos o ID correto gerado pelo WTForms
            const localSelect = document.getElementById('{{ form.local.id }}');
            const outroLocalContainer = document.getElementById('outro-local-container');
            const outroLocalInput = document.getElementById('{{ form.outro_local_texto.id }}');

            function toggleOutroLocal() {
                if (localSelect.value === 'Outro Local / Não Listado') {
                    outroLocalContainer.style.display = 'block';
                    outroLocalInput.required = true;
                } else {
                    outroLocalContainer.style.display = 'none';
                    outroLocalInput.required = false;
                }
            }

            localSelect.addEventListener('change', toggleOutroLocal);
            
            toggleOutroLocal();
            updateCounter('{{ form.titulo.id }}', 100);
            updateCounter('{{ form.descricao.id }}', 2000);
        });

        function updateCounter(fieldId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(fieldId + '-counter');
            if (field && counter) {
                const remaining = maxLength - field.value.length;
                counter.textContent = remaining;
                counter.style.color = remaining < 20 ? (remaining < 0 ? '#ff0000' : '#ffc107') : '#aaa';
            }
        }
    </script>
{% endblock %}